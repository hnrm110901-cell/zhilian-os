# 智链OS - 研发指令集

## 文档概述

本文档为智链OS开发团队提供标准化的研发指令集，包括开发规范、部署流程、故障排查、性能优化等核心内容。

**版本**: v1.0
**最后更新**: 2026-02-20
**适用范围**: 智链OS全栈开发

---

## 目录

1. [开发环境配置](#1-开发环境配置)
2. [代码开发规范](#2-代码开发规范)
3. [测试指令集](#3-测试指令集)
4. [部署指令集](#4-部署指令集)
5. [监控与告警](#5-监控与告警)
6. [故障排查指南](#6-故障排查指南)
7. [性能优化指南](#7-性能优化指南)
8. [安全加固指南](#8-安全加固指南)
9. [CI/CD流程](#9-cicd流程)
10. [API速率限制](#10-api速率限制)

---

## 1. 开发环境配置

### 1.1 前置要求

```bash
# 检查系统要求
python --version  # >= 3.11
node --version    # >= 18.0
docker --version  # >= 24.0
```

### 1.2 快速启动

```bash
# 克隆项目
git clone https://github.com/your-org/zhilian-os.git
cd zhilian-os

# 安装后端依赖
cd apps/api-gateway
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt

# 安装前端依赖
cd ../../apps/web-dashboard
pnpm install

# 启动开发环境
docker-compose up -d redis postgres
cd ../api-gateway
uvicorn src.main:app --reload --port 8000

# 另开终端启动前端
cd ../web-dashboard
pnpm dev
```

### 1.3 环境变量配置

```bash
# 复制环境变量模板
cp .env.example .env

# 必需配置项
DATABASE_URL=postgresql://user:pass@localhost:5432/zhilian
REDIS_URL=redis://localhost:6379/0
JWT_SECRET_KEY=your-secret-key-here
OPENAI_API_KEY=sk-xxx  # 或其他LLM API密钥
```

---

## 2. 代码开发规范

### 2.1 Git工作流

```bash
# 创建功能分支
git checkout -b feature/agent-optimization

# 提交代码
git add .
git commit -m "feat: 优化InventoryAgent性能"

# 推送到远程
git push origin feature/agent-optimization

# 创建Pull Request
gh pr create --title "优化InventoryAgent性能" --body "详细说明..."
```

### 2.2 提交信息规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type类型**:
- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具链相关

**示例**:
```
feat(agent): 添加库存预警Agent

- 实现实时库存监控
- 添加智能补货建议
- 集成保质期管理

Closes #123
```

### 2.3 代码审查清单

- [ ] 代码符合PEP 8 / ESLint规范
- [ ] 添加必要的单元测试
- [ ] 更新相关文档
- [ ] 通过所有CI检查
- [ ] 无安全漏洞
- [ ] 性能无明显下降

---

## 3. 测试指令集

### 3.1 后端测试

```bash
# 运行所有测试
cd apps/api-gateway
pytest

# 运行特定测试文件
pytest tests/test_inventory_service.py

# 运行特定测试类
pytest tests/test_inventory_service.py::TestInventoryService

# 运行特定测试方法
pytest tests/test_inventory_service.py::TestInventoryService::test_monitor_inventory

# 生成覆盖率报告
pytest --cov=src --cov-report=html
open htmlcov/index.html

# 运行性能测试
pytest tests/test_performance_benchmarks.py -v

# 运行集成测试
pytest tests/test_api_integration.py -v
```

### 3.2 前端测试

```bash
cd apps/web-dashboard

# 运行单元测试
pnpm test

# 运行特定测试
pnpm test -- Dashboard.test.tsx

# 生成覆盖率报告
pnpm test:coverage

# 运行E2E测试
pnpm test:e2e
```

### 3.3 测试数据准备

```bash
# 创建测试数据库
python scripts/create_test_db.py

# 加载测试数据
python scripts/load_test_data.py

# 清理测试数据
python scripts/cleanup_test_data.py
```

---

## 4. 部署指令集

### 4.1 开发环境部署

```bash
# 使用Docker Compose
docker-compose up -d

# 查看日志
docker-compose logs -f api

# 重启服务
docker-compose restart api

# 停止所有服务
docker-compose down
```

### 4.2 生产环境部署

```bash
# 构建生产镜像
docker build -t zhilian-api:latest -f Dockerfile.prod .

# 推送到镜像仓库
docker tag zhilian-api:latest registry.example.com/zhilian-api:latest
docker push registry.example.com/zhilian-api:latest

# Kubernetes部署
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml
kubectl apply -f k8s/ingress.yaml

# 查看部署状态
kubectl get pods -n zhilian
kubectl logs -f deployment/zhilian-api -n zhilian

# 滚动更新
kubectl set image deployment/zhilian-api api=registry.example.com/zhilian-api:v1.2.0 -n zhilian

# 回滚
kubectl rollout undo deployment/zhilian-api -n zhilian
```

### 4.3 数据库迁移

```bash
# 创建迁移
alembic revision --autogenerate -m "添加库存表"

# 执行迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1

# 查看迁移历史
alembic history

# 查看当前版本
alembic current
```

---

## 5. 监控与告警

### 5.1 健康检查

```bash
# API健康检查
curl http://localhost:8000/health

# 详细健康状态
curl http://localhost:8000/health/detailed

# Agent状态检查
curl http://localhost:8000/api/v1/agents/status
```

### 5.2 Prometheus指标

```bash
# 访问指标端点
curl http://localhost:8000/metrics

# 常用指标
# - http_requests_total: 总请求数
# - http_request_duration_seconds: 请求延迟
# - agent_execution_time_seconds: Agent执行时间
# - database_connections_active: 活跃数据库连接数
```

### 5.3 日志查询

```bash
# 查看实时日志
docker-compose logs -f api

# 查看错误日志
docker-compose logs api | grep ERROR

# 查看特定Agent日志
docker-compose logs api | grep "InventoryAgent"

# 导出日志
docker-compose logs api > api-logs-$(date +%Y%m%d).log
```

---

## 6. 故障排查指南

### 6.1 常见问题诊断

#### 问题1: API响应慢

```bash
# 1. 检查数据库连接
psql -h localhost -U zhilian -d zhilian -c "SELECT count(*) FROM pg_stat_activity;"

# 2. 检查慢查询
psql -h localhost -U zhilian -d zhilian -c "
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;"

# 3. 检查Redis连接
redis-cli ping
redis-cli info stats

# 4. 查看系统资源
docker stats

# 5. 分析请求日志
grep "duration_ms" api-logs.log | awk '{print $NF}' | sort -n | tail -20
```

#### 问题2: Agent执行失败

```bash
# 1. 查看Agent日志
docker-compose logs api | grep "AgentError"

# 2. 检查Agent配置
curl http://localhost:8000/api/v1/agents/inventory/config

# 3. 测试Agent执行
curl -X POST http://localhost:8000/api/v1/agents/inventory/execute \
  -H "Content-Type: application/json" \
  -d '{"action": "monitor", "params": {}}'

# 4. 检查依赖服务
curl http://localhost:8000/health/dependencies
```

#### 问题3: 数据库连接池耗尽

```bash
# 1. 查看当前连接数
psql -c "SELECT count(*) FROM pg_stat_activity WHERE datname='zhilian';"

# 2. 查看连接详情
psql -c "SELECT pid, usename, application_name, state, query
FROM pg_stat_activity WHERE datname='zhilian';"

# 3. 终止空闲连接
psql -c "SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname='zhilian' AND state='idle' AND state_change < now() - interval '5 minutes';"

# 4. 调整连接池配置
# 编辑 src/core/database.py
# SQLALCHEMY_POOL_SIZE = 20
# SQLALCHEMY_MAX_OVERFLOW = 10
```

### 6.2 紧急故障处理

```bash
# 1. 快速回滚
kubectl rollout undo deployment/zhilian-api -n zhilian

# 2. 扩容应对流量
kubectl scale deployment/zhilian-api --replicas=5 -n zhilian

# 3. 重启服务
kubectl rollout restart deployment/zhilian-api -n zhilian

# 4. 查看错误日志
kubectl logs -f deployment/zhilian-api -n zhilian --tail=100 | grep ERROR

# 5. 进入容器调试
kubectl exec -it deployment/zhilian-api -n zhilian -- /bin/bash
```

---

## 7. 性能优化指南

### 7.1 数据库优化

```sql
-- 创建索引
CREATE INDEX idx_orders_store_time ON orders(store_id, order_time);
CREATE INDEX idx_inventory_store_status ON inventory_items(store_id, status);

-- 分析查询计划
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE store_id = 'STORE001'
AND order_time >= '2024-01-01';

-- 更新统计信息
ANALYZE orders;
VACUUM ANALYZE orders;

-- 查看表大小
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 7.2 缓存优化

```python
# Redis缓存策略
from functools import lru_cache
from redis import Redis

redis_client = Redis(host='localhost', port=6379, db=0)

# 1. 缓存热点数据
def get_store_info(store_id: str):
    cache_key = f"store:{store_id}"
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)

    # 从数据库查询
    store = db.query(Store).filter(Store.id == store_id).first()
    redis_client.setex(cache_key, 3600, json.dumps(store.to_dict()))
    return store.to_dict()

# 2. 使用LRU缓存
@lru_cache(maxsize=128)
def calculate_distance(lat1, lon1, lat2, lon2):
    # 计算地理距离
    pass
```

### 7.3 API性能优化

```python
# 1. 使用异步处理
from fastapi import BackgroundTasks

@app.post("/orders")
async def create_order(order: OrderCreate, background_tasks: BackgroundTasks):
    # 同步创建订单
    order_id = await order_service.create_order(order)

    # 异步发送通知
    background_tasks.add_task(send_order_notification, order_id)

    return {"order_id": order_id}

# 2. 批量查询优化
async def get_orders_with_items(store_id: str):
    # 使用selectinload避免N+1查询
    stmt = (
        select(Order)
        .options(selectinload(Order.items))
        .where(Order.store_id == store_id)
    )
    result = await session.execute(stmt)
    return result.scalars().all()

# 3. 分页查询
@app.get("/orders")
async def list_orders(skip: int = 0, limit: int = 20):
    orders = await order_service.list_orders(skip=skip, limit=limit)
    return orders
```

---

## 8. 安全加固指南

### 8.1 API安全

```python
# 1. 实现API密钥认证
from fastapi import Security, HTTPException
from fastapi.security import APIKeyHeader

api_key_header = APIKeyHeader(name="X-API-Key")

async def verify_api_key(api_key: str = Security(api_key_header)):
    if api_key not in valid_api_keys:
        raise HTTPException(status_code=403, detail="Invalid API Key")
    return api_key

# 2. 添加请求签名验证
import hmac
import hashlib

def verify_signature(payload: str, signature: str, secret: str) -> bool:
    expected = hmac.new(
        secret.encode(),
        payload.encode(),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(expected, signature)

# 3. 防止SQL注入
# 使用参数化查询
stmt = select(User).where(User.username == username)  # 安全
# 避免字符串拼接
# stmt = f"SELECT * FROM users WHERE username = '{username}'"  # 不安全
```

### 8.2 数据加密

```python
# 1. 敏感数据加密
from cryptography.fernet import Fernet

cipher = Fernet(settings.ENCRYPTION_KEY)

def encrypt_data(data: str) -> str:
    return cipher.encrypt(data.encode()).decode()

def decrypt_data(encrypted: str) -> str:
    return cipher.decrypt(encrypted.encode()).decode()

# 2. 密码哈希
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain: str, hashed: str) -> bool:
    return pwd_context.verify(plain, hashed)
```

### 8.3 安全配置检查

```bash
# 1. 检查敏感信息泄露
grep -r "password\|secret\|key" --include="*.py" --exclude-dir=venv .

# 2. 检查依赖漏洞
pip install safety
safety check

# 3. 代码安全扫描
pip install bandit
bandit -r src/

# 4. 检查Docker镜像漏洞
docker scan zhilian-api:latest
```

---

## 9. CI/CD流程

### 9.1 GitHub Actions配置

创建 `.github/workflows/ci.yml`:

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd apps/api-gateway
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run tests
      run: |
        cd apps/api-gateway
        pytest --cov=src --cov-report=xml

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./apps/api-gateway/coverage.xml

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Lint with flake8
      run: |
        pip install flake8
        flake8 apps/api-gateway/src --count --select=E9,F63,F7,F82 --show-source --statistics

  build:
    needs: [test, lint]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Build Docker image
      run: |
        docker build -t zhilian-api:${{ github.sha }} -f Dockerfile.prod .

    - name: Push to registry
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker tag zhilian-api:${{ github.sha }} registry.example.com/zhilian-api:latest
        docker push registry.example.com/zhilian-api:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to Kubernetes
      run: |
        kubectl set image deployment/zhilian-api api=registry.example.com/zhilian-api:${{ github.sha }} -n zhilian
        kubectl rollout status deployment/zhilian-api -n zhilian
```

### 9.2 本地CI测试

```bash
# 安装act (本地运行GitHub Actions)
brew install act  # macOS
# 或
curl https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash

# 运行CI流程
act -j test

# 运行特定job
act -j lint

# 使用自定义secrets
act -j deploy --secret-file .secrets
```

---

## 10. API速率限制

### 10.1 实现速率限制

创建 `src/middleware/rate_limit.py`:

```python
from fastapi import Request, HTTPException
from redis import Redis
import time

redis_client = Redis(host='localhost', port=6379, db=1)

class RateLimiter:
    def __init__(self, requests: int = 100, window: int = 60):
        """
        Args:
            requests: 时间窗口内允许的请求数
            window: 时间窗口（秒）
        """
        self.requests = requests
        self.window = window

    async def __call__(self, request: Request):
        # 获取客户端标识（IP或API Key）
        client_id = request.client.host
        if api_key := request.headers.get("X-API-Key"):
            client_id = f"api_key:{api_key}"

        # Redis key
        key = f"rate_limit:{client_id}"

        # 获取当前计数
        current = redis_client.get(key)

        if current is None:
            # 首次请求，设置计数器
            redis_client.setex(key, self.window, 1)
        elif int(current) >= self.requests:
            # 超过限制
            raise HTTPException(
                status_code=429,
                detail=f"Rate limit exceeded. Max {self.requests} requests per {self.window} seconds"
            )
        else:
            # 增加计数
            redis_client.incr(key)

        return True

# 使用示例
from fastapi import Depends

rate_limiter = RateLimiter(requests=100, window=60)

@app.get("/api/v1/orders", dependencies=[Depends(rate_limiter)])
async def list_orders():
    return await order_service.list_orders()
```

### 10.2 分级速率限制

```python
# 不同用户等级的速率限制
RATE_LIMITS = {
    "free": RateLimiter(requests=10, window=60),
    "basic": RateLimiter(requests=100, window=60),
    "premium": RateLimiter(requests=1000, window=60),
    "enterprise": RateLimiter(requests=10000, window=60),
}

async def get_rate_limiter(request: Request):
    # 根据用户等级返回对应的限制器
    user_tier = request.state.user.tier if hasattr(request.state, "user") else "free"
    return RATE_LIMITS.get(user_tier, RATE_LIMITS["free"])

@app.get("/api/v1/orders")
async def list_orders(rate_limiter = Depends(get_rate_limiter)):
    await rate_limiter(request)
    return await order_service.list_orders()
```

### 10.3 监控速率限制

```python
# 添加Prometheus指标
from prometheus_client import Counter, Histogram

rate_limit_exceeded = Counter(
    'rate_limit_exceeded_total',
    'Total number of rate limit exceeded errors',
    ['client_id', 'endpoint']
)

rate_limit_requests = Histogram(
    'rate_limit_requests',
    'Rate limit request distribution',
    ['client_id']
)

# 在RateLimiter中添加监控
class RateLimiter:
    async def __call__(self, request: Request):
        # ... 现有代码 ...

        if int(current) >= self.requests:
            rate_limit_exceeded.labels(
                client_id=client_id,
                endpoint=request.url.path
            ).inc()
            raise HTTPException(status_code=429, detail="Rate limit exceeded")

        rate_limit_requests.labels(client_id=client_id).observe(int(current))
```

---

## 附录

### A. 常用命令速查

```bash
# 开发
pnpm dev                    # 启动前端开发服务器
uvicorn src.main:app --reload  # 启动后端开发服务器

# 测试
pytest                      # 运行所有测试
pytest --cov               # 运行测试并生成覆盖率
pnpm test                  # 运行前端测试

# 部署
docker-compose up -d       # 启动所有服务
kubectl apply -f k8s/      # 部署到Kubernetes

# 数据库
alembic upgrade head       # 执行数据库迁移
alembic downgrade -1       # 回滚一个版本

# 监控
docker-compose logs -f     # 查看日志
kubectl logs -f pod/xxx    # 查看K8s日志
```

### B. 环境变量清单

| 变量名 | 说明 | 示例 | 必需 |
|--------|------|------|------|
| DATABASE_URL | 数据库连接 | postgresql://... | ✅ |
| REDIS_URL | Redis连接 | redis://localhost:6379 | ✅ |
| JWT_SECRET_KEY | JWT密钥 | random-secret-key | ✅ |
| OPENAI_API_KEY | OpenAI密钥 | sk-xxx | ✅ |
| ENVIRONMENT | 运行环境 | development/production | ✅ |
| LOG_LEVEL | 日志级别 | INFO/DEBUG/ERROR | ❌ |
| CORS_ORIGINS | CORS来源 | http://localhost:3000 | ❌ |

### C. 联系方式

- **技术支持**: tech-support@zhilian-os.com
- **紧急联系**: +86 138-0013-8000
- **文档反馈**: docs@zhilian-os.com

---

**文档维护**: 开发团队
**审核**: 技术负责人
**生效日期**: 2026-02-20
