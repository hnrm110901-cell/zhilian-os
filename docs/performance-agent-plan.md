# 连锁餐饮绩效 Agent 规划

基于连锁餐饮行业门店各岗位绩效与提成结构，规划一套与智链OS 现有 Agent 体系衔接的**绩效 Agent（Performance Agent）**，负责岗位绩效计算、提成规则引擎、绩效报表与自然语言查询。

---

## 一、连锁餐饮门店岗位绩效与提成结构（行业参考）

### 1.1 岗位与绩效维度总览

| 岗位 | 绩效维度 | 典型权重/说明 | 提成/激励形式 |
|------|----------|----------------|----------------|
| **店长** | 营收、利润、人效、满意度、食品安全、损耗 | 营收/利润 40–50%，人效/满意度各约 15–20% | 月度/季度奖金、利润分成、超额提成 |
| **值班经理** | 时段营收、翻台率、客诉、排班执行、现场秩序 | 时段业绩 30–40%，客诉/安全 30% | 月度绩效奖、时段超额奖 |
| **服务员** | 桌均消费、加单率、好评率、出勤、服务时效 | 桌均/加单 40–50%，好评/出勤 30% | 桌均提成、好评奖、加单提成 |
| **收银** | 收银准确率、差错率、会员开卡、储值/卡券销售 | 准确率 40%，会员/储值 40% | 会员开卡提成、储值/卡券提成 |
| **后厨/厨师** | 出餐时效、退菜率、损耗、标准化执行、食品安全 | 出餐时效 30%，退菜/损耗 30% | 计件/出餐量奖、减损奖 |
| **外卖专员** | 外卖单量、准时率、差评率、包装与漏送 | 单量 40%，准时/差评 40% | 单量提成、准时奖、差评扣减 |

### 1.2 各岗位绩效指标与提成规则（可配置）

#### 店长

- **绩效指标**：门店营收、毛利/利润、人效（营收/人时）、客户满意度、食品安全事故、损耗率、人员流失率。
- **提成/奖金**：月度目标达成奖（如营收/利润达标按比例）、超额提成（超额部分 1–3%）、季度综合排名奖。
- **数据来源**：POS/ERP 营收与成本、BI 报表、满意度调研、食安与损耗记录、HR 考勤/离职。

#### 值班经理

- **绩效指标**：负责时段营收、翻台率、客诉次数与处理时效、排班执行率、现场巡检与异常上报。
- **提成/奖金**：时段业绩达标奖、客诉零事故奖、月度绩效系数。
- **数据来源**：POS 时段营收、排班系统、客诉工单、巡检记录。

#### 服务员

- **绩效指标**：桌均消费、加单/加菜率、好评率（美团/大众点评/店内）、出勤率、平均服务时长/响应。
- **提成/奖金**：桌均提成（桌均超基线按比例）、加单提成、好评数/星级奖、满勤奖。
- **数据来源**：POS 桌台与订单、评价平台 API、考勤、服务计时（若有）。

#### 收银

- **绩效指标**：收银准确率、长短款/差错率、会员开卡数、储值/卡券销售金额。
- **提成/奖金**：会员开卡提成（元/张）、储值/卡券销售提成（%）。
- **数据来源**：POS 收银记录、会员系统、储值/卡券流水。

#### 后厨/厨师

- **绩效指标**：出餐时效（从下单到出餐）、退菜率、损耗率、标准化执行（SOP 抽查）、食品安全项。
- **提成/奖金**：出餐量/计件奖、退菜率低于阈值奖、损耗节约奖。
- **数据来源**：KDS/订单时间戳、退菜记录、进销存/损耗、食安巡检。

#### 外卖专员

- **绩效指标**：外卖单量、准时率、差评率、漏送/错送率、包装规范。
- **提成/奖金**：单量提成（元/单或阶梯）、准时奖、差评扣减。
- **数据来源**：外卖平台 API、配送时效、评价与投诉。

### 1.3 通用规则与约束

- **保底与封顶**：提成可设保底（如不低于基本工资的 x%）和封顶（如单月提成不超过 y 倍基本工资）。
- **红线指标**：食品安全事故、重大客诉、作弊行为等一票否决或大幅扣减。
- **周期**：日/周/月/季度；结算周期与工资发放对齐，支持预发与决算。
- **多店/区域**：店长/区域经理可叠加门店排名、区域利润分成。

---

## 二、绩效 Agent 定位与边界

### 2.1 与现有 KPI Agent 的关系

| 维度 | KPI Agent（现有） | 绩效 Agent（本规划） |
|------|-------------------|----------------------|
| 重心 | 门店/员工**绩效评估、分析与改进建议**（RAG+LLM） | **岗位绩效计算、提成规则执行、报表与查询**（规则引擎+数据聚合） |
| 输出 | 评估报告、优劣势分析、改进计划、趋势预测 | 得分、提成金额、绩效报表、规则解释、NL 查询答案 |
| 数据 | 主要用 RAG/事件与历史数据做分析 | 强依赖 POS/ERP/考勤/会员等结构化业务数据 |
| 典型调用 | 运营看原因、做改进 | 薪酬结算、店长/HR 查绩效与提成、员工自助查询 |

二者协作方式：绩效 Agent 产出**结构化绩效与提成结果**；KPI Agent 可消费这些结果做**分析与洞察**（如“为什么本月服务员提成下降”）。

### 2.2 绩效 Agent 目标

- **自动化**：按配置的岗位规则，自动汇总数据、计算绩效得分与提成，减少人工 Excel 与差错。
- **可解释**：每项得分与提成可追溯到规则与数据来源（规则引擎+审计日志）。
- **可配置**：支持按品牌/区域/门店配置岗位、指标权重、提成公式与红线。
- **可查询**：支持 NL 查询（如“A 店 2 月服务员提成总和”“店长绩效公式是什么”）。

---

## 三、绩效 Agent 架构与能力设计

### 3.1 能力列表（Actions）

| Action | 说明 | 典型入参 | 典型出参 |
|--------|------|----------|----------|
| **get_role_config** | 获取岗位绩效与提成配置 | store_id?, role_id? | 岗位列表及指标/权重/提成公式 |
| **calculate_performance** | 计算指定岗位、周期、人员绩效得分 | store_id, role_id, period, staff_ids? | 得分明细、指标达成、数据来源 |
| **calculate_commission** | 计算提成金额 | store_id, role_id, period, staff_ids? | 提成明细、公式追溯、红线扣减说明 |
| **get_performance_report** | 绩效报表（门店/岗位/个人） | store_id, period, role_id?, format | 报表结构（列表/汇总/趋势） |
| **explain_rule** | 解释某条规则或某笔提成 | rule_id 或 commission_id | 规则原文、适用数据、计算过程 |
| **nl_query** | 自然语言查询绩效/提成 | query, store_id?, period? | 答案+引用数据与规则 |

### 3.2 数据依赖与对接

- **POS/收银**：桌台、订单、时段营收、支付与退款、收银员维度。
- **ERP/进销存**：成本、损耗、退菜、出餐关联（若有时戳）。
- **会员/私域**：开卡、储值、卡券销售（按收银员/门店）。
- **排班/考勤**：人天、人时、出勤、排班执行（供人效、满勤等）。
- **评价/外卖**：好评、差评、准时率、单量（平台 API 或埋点）。
- **食安/巡检**：事故、违规、巡检结果（红线与扣减）。

与智链OS 现有组件的对接建议：  
- 绩效 Agent 通过**统一数据服务或数仓**读取上述数据（不替代 POS/ERP，只读）；  
- 排班、订单、私域等 Agent 已具备的能力可被绩效 Agent **调用或消费其输出**（如排班执行率、订单维度汇总）。

### 3.3 规则引擎要点

- **配置存储**：岗位定义、指标定义、权重、提成公式（如“桌均超 80 元部分按 2% 提成”）、红线与一票否决、保底/封顶。
- **公式执行**：支持简单表达式（加减乘除、条件、min/max）与阶梯（如单量 0–100 单 1 元/单，100–200 单 1.2 元/单）。
- **追溯**：每条提成/每项得分可关联到规则版本、数据快照或数据源查询条件，便于审计与解释。

### 3.4 与智链OS 其他 Agent 的协作

| Agent | 协作方式 |
|-------|----------|
| **KPI Agent** | 消费绩效 Agent 的得分/提成结果做分析、改进计划与趋势解读 |
| **排班 Agent** | 获取排班执行率、人时数据，用于值班经理/店长人效、服务员出勤 |
| **订单 Agent** | 获取订单维度汇总（桌均、加单、时段）用于服务员/值班经理 |
| **私域 Agent** | 会员开卡、储值等用于收银岗位绩效与提成 |
| **运维 Agent** | 不直接耦合；食安/设备异常可作红线数据来源 |
| **决策/报表** | 绩效报表作为经营报表的一部分；决策看板展示门店/岗位绩效与提成汇总 |

---

## 四、接口与实现形态

### 4.1 与现有 Agent 规范对齐

- 遵循智链OS **BaseAgent** 抽象：`execute(action, params)`、`get_supported_actions()`。
- 请求方式：`POST /api/agents/performance`，body：`input_data.action` + `input_data.params`。
- 响应：与现有 Agent 一致（如 `AgentResponse` 或现有网关约定），包含 success、data、error、execution_time；其中 data 内可含 reasoning、source_data（规则 id、数据周期、关键指标值）便于审计与前端展示。

### 4.2 建议的 Action 与 params 示例

```text
# 计算绩效
action: calculate_performance
params: { "store_id": "STORE_001", "role_id": "waiter", "period": "2024-02", "staff_ids": ["E001","E002"] }

# 计算提成
action: calculate_commission
params: { "store_id": "STORE_001", "role_id": "waiter", "period": "2024-02" }

# 绩效报表
action: get_performance_report
params: { "store_id": "STORE_001", "period": "2024-02", "role_id": "waiter", "format": "summary" }

# 自然语言查询
action: nl_query
params: { "query": "A店2月服务员提成总和是多少？", "store_id": "STORE_001", "period": "2024-02" }
```

### 4.3 技术栈建议

- **规则引擎**：可先用配置表 + 表达式求值（如 safe_eval 或小型 DSL），后续可接 Drools/自研引擎。
- **数据层**：从数仓/聚合表读已清洗的指标（按门店、岗位、人、日/周/月），避免在 Agent 内直接扫 POS 原始表。
- **LLM**：仅用于 `nl_query` 的意图识别与答案生成，结构化计算一律用规则+数据，保证可审计。

---

## 五、实施阶段建议

| 阶段 | 内容 | 周期 |
|------|------|------|
| **1. 配置与模型** | 岗位/指标/提成配置表设计；规则 DSL 或表达式规范；与权限（按门店/角色可见） | 2–3 周 |
| **2. 数据管道** | 从 POS/ERP/考勤/会员等落绩效宽表或指标表；按门店-岗位-人-周期可聚合 | 2–4 周 |
| **3. 核心 Agent** | 实现 calculate_performance、calculate_commission、get_performance_report；规则引擎 + 追溯 | 3–4 周 |
| **4. 解释与 NL** | explain_rule、nl_query；与 RAG/LLM 集成（仅 NL 部分） | 1–2 周 |
| **5. 对接与上线** | 注册到 Agent 网关、权限、与 KPI/排班/订单等 Agent 或报表对接；试点门店 | 2–3 周 |

---

## 六、小结

- **岗位与提成**：店长、值班经理、服务员、收银、后厨、外卖专员等岗位的绩效维度与提成形式已按行业惯例梳理，可作为配置模板与规则设计输入。
- **绩效 Agent**：定位为“**绩效计算与提成执行**”，与现有“**评估与分析**”的 KPI Agent 互补，通过规则引擎 + 结构化数据产出可审计的得分与提成，并支持规则解释与自然语言查询。
- **落地**：与智链OS 统一 Agent 接口与数据体系对齐，分阶段实现配置、数据、核心计算、解释与 NL、对接上线，即可形成一套可用的连锁餐饮绩效 Agent。

---

## 七、已实现与部署

### 7.1 已实现（智链OS api-gateway）

- **PerformanceAgent**（`apps/api-gateway/src/agents/performance_agent.py`）：6 个 action 已实现（get_role_config、calculate_performance、calculate_commission、get_performance_report、explain_rule、nl_query），当前计算与报表为占位结构，接入指标表与规则引擎后可产出真实数据。
- **API**：`POST /api/agents/performance`，body：`{ "agent_type": "performance", "input_data": { "action": "<action>", "params": { ... } } }`。
- **权限**：`AGENT_PERFORMANCE_READ` / `AGENT_PERFORMANCE_WRITE`，店长、店长助理、财务可访问。

### 7.2 服务器同步步骤

代码已提交并推送至 GitHub 后，在服务器上执行：

```bash
# 1. 进入项目目录（按实际路径调整）
cd /opt/zhilian-os   # 或 deploy.sh 中的 APP_DIR

# 2. 拉取最新代码
git pull origin main

# 3. 重启 API 服务（按实际部署方式二选一）
# 若使用 systemd/supervisor：
sudo systemctl restart zhilian-api   # 或 supervisorctl restart api-gateway

# 若使用 Docker：
docker-compose -f docker-compose.prod.yml up -d --build api-gateway
```

拉取并重启后，绩效 Agent 即可通过 `POST /api/agents/performance` 调用。
