# 业财凭证规则与金蝶/用友及企业会计准则对照说明

本文档说明智链OS 业财税资金一体化模块中**凭证规则**与企业会计准则、金蝶与用友财务软件常见规范的对应关系，便于实施与审计对齐。

---

## 一、依据与范围

| 依据 | 说明 |
|------|------|
| **企业会计准则应用指南**（财会〔2006〕18 号） | 科目编码与名称、借贷方向、核算要求。 |
| **金蝶 / 用友** | 凭证借贷必平、金额精度（两位小数）、尾差容差（通常 0.01 元）、辅助核算用法。 |
| **智链OS 实现** | `apps/api-gateway/src/services/fct_service.py` 中门店日结、采购入库等规则。 |

---

## 二、科目编码与名称对照

智链OS 默认科目编码与准则及金蝶/用友常用编码一致，便于导出或对接财务系统。

| 编码 | 名称 | 准则/软件对应 | 说明 |
|------|------|----------------|------|
| 1001 | 库存现金 | 准则 1001 | 日结中非银联/第三方支付记入此科目。 |
| 1002 | 银行存款 | 准则 1002 | 日结中微信/支付宝/银行卡记入此科目。 |
| 1405 | 库存商品 | 准则 1405 | 采购入库存货成本（不含税）。 |
| 2202 | 应付账款 | 准则 2202 | 采购应付，辅助核算供应商。 |
| 2221 | 应交税费 | 准则 2221 | 销项税额（门店日结）。 |
| 2221_01 | 应交税费-应交增值税-进项税额 | 2221 子目 | 采购进项税。 |
| 6001 | 主营业务收入 | 准则 6001 | 门店日结收入（不含税）。 |

金额单位：业务侧以「分」上送，凭证分录以「元」存储，精度 **两位小数**（`Numeric(18,2)`），与金蝶/用友一致。

---

## 三、借贷平衡与尾差

- **原则**：凭证保存前必须 **借贷相等**；与金蝶/用友一致。
- **尾差**：允许 **0.01 元** 尾差（`VOUCHER_BALANCE_TOLERANCE = 0.01`），避免浮点或四舍五入导致无法过账。
- **实现**：
  - `FctService._voucher_totals(lines)`：计算分录借方、贷方合计。
  - `FctService._is_balanced(total_debit, total_credit)`：判断是否在容差内平衡。
  - 门店日结、采购入库在写库前均做平衡校验；门店日结若不平衡则自动做**差额调整**（见下）。

---

## 四、门店日结凭证规则

- **业务含义**：门店当日销售收款入账。
- **分录逻辑**：
  - **借方**：按 `payment_breakdown` 拆分——微信/支付宝/银行卡记「银行存款」，其他记「库存现金」；无明细时合并一笔「银行存款」。
  - **贷方**：主营业务收入 = (total_sales - discounts)/100 - tax；应交税费（销项）= total_sales_tax/100。
- **差额调整**：当支付明细合计与收入+税合计不一致时（如四舍五入或漏项），自动增加一行「差额调整」：
  - 借方合计 < 贷方合计 → 补 **借 银行存款**；
  - 借方合计 > 贷方合计 → 补 **贷 银行存款**。  
  保证保存前凭证借贷平衡，符合金蝶/用友过账要求。
- **与准则/软件**：销售收款「借 银行存款/库存现金 贷 主营业务收入、应交税费-销项」与准则及金蝶/用友标准做法一致。

---

## 五、采购入库凭证规则

- **业务含义**：采购到货、价税分离入账。
- **分录逻辑**：
  - **借**：库存商品 (total - tax)/100；应交税费-进项税额 tax/100（若有税）。
  - **贷**：应付账款 total/100；辅助核算 `supplier_id`。
- **平衡**：价税分离后借、贷均为 total/100，理论平衡；保存前仍做一次平衡校验，不平衡时打日志（不自动调差，因采购数据应由上游保证一致）。
- **与准则/软件**：采购入账「借 存货、进项税 贷 应付账款」及辅助核算供应商，与准则及金蝶/用友采购模块一致。

---

## 六、测试与校验

- **单元测试**：`tests/test_fct_voucher_rules.py`
  - 借贷平衡辅助方法：`_voucher_totals`、`_is_balanced`、尾差 0.01。
  - 科目常量与准则编码一致（1001/1002/1405/2202/2221/2221_01/6001）。
  - 门店日结：无/有 `payment_breakdown`、必填 `biz_date`、凭证平衡与科目存在性（需 PostgreSQL）。
  - 采购入库：平衡、科目与辅助核算、必填 `biz_date`（需 PostgreSQL）。
- **运行**：  
  `python3 -m pytest tests/test_fct_voucher_rules.py -v`  
  无测试库时，仅依赖 DB 的用例会跳过，其余用例可验证规则与常量。

---

## 七、与金蝶/用友对接建议

1. **科目**：若客户使用自定义科目表，可在智链OS 中通过主数据或配置映射 1001/1002/6001/2221/2202/1405 等为客户编码。
2. **精度与平衡**：已按 0.01 元尾差与两位小数实现，导出凭证时可直接按分录借贷汇总校验。
3. **辅助核算**：应付账款供应商、支付方式等已写入 `auxiliary`，导出时可映射为金蝶/用友的辅助核算维度。
4. **期间与凭证号**：凭证号格式为 `V + 日期 + 主体 + 序号`，可按需映射为对方系统凭证号或凭证明细。

---

**文档版本**：与 Phase 1/2/3 凭证规则实现同步；若规则或科目有变更，请同步更新本文档与 `fct_service.py` 内注释。
