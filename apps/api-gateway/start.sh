#!/bin/bash

# æ™ºé“¾OS API Gateway å¯åŠ¨è„šæœ¬

set -e

echo "ğŸš€ å¯åŠ¨æ™ºé“¾OS API Gateway..."

# æ£€æŸ¥Pythonç‰ˆæœ¬
python_version=$(python3 --version 2>&1 | awk '{print $2}')
echo "âœ“ Pythonç‰ˆæœ¬: $python_version"

# æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
if [ ! -f "src/main.py" ]; then
    echo "âŒ é”™è¯¯: è¯·åœ¨ apps/api-gateway ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
if [ ! -f ".env" ]; then
    echo "âš ï¸  è­¦å‘Š: .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ .env.example åˆ›å»º..."
    if [ -f ".env.example" ]; then
        cp .env.example .env
        echo "âœ“ å·²åˆ›å»º .env æ–‡ä»¶ï¼Œè¯·ç¼–è¾‘é…ç½®åé‡æ–°è¿è¡Œ"
        exit 0
    else
        echo "âŒ é”™è¯¯: .env.example æ–‡ä»¶ä¸å­˜åœ¨"
        exit 1
    fi
fi

# æ£€æŸ¥ä¾èµ–
echo "ğŸ“¦ æ£€æŸ¥ä¾èµ–..."
if ! python3 -c "import fastapi" 2>/dev/null; then
    echo "âš ï¸  è­¦å‘Š: ä¾èµ–æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
    pip install -r requirements.txt
fi

# è®¾ç½®ç¯å¢ƒå˜é‡
export PYTHONPATH="${PYTHONPATH}:$(pwd)"

# å¯åŠ¨æœåŠ¡
echo "ğŸŒŸ å¯åŠ¨æœåŠ¡..."
echo "ğŸ“ APIæ–‡æ¡£: http://localhost:8000/docs"
echo "ğŸ“ å¥åº·æ£€æŸ¥: http://localhost:8000/api/v1/health"
echo ""

python3 -m uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
